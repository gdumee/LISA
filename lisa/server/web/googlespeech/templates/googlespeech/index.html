{% extends "base/base.html" %}

{% block title %}{{ section.title }}{% endblock %}
{% block javascript %}
<script type="text/javascript">
        //var url = '/api/v1/lisa/tts/google/';
        var url = '/api/v1/lisa/tts/pico/';
        var source;
        var context = new webkitAudioContext();
        var analyser = context.createAnalyser();
        var canvas=document.getElementById('canvas1');
        var canvasContext=canvas.getContext('2d');
        var isFinished = false;

        function playSound(buffer) {
            source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(analyser);
            analyser.connect(context.destination);
            source.onended = function() {
                isFinished = true;
                cancelAnimationFrame(globalID);
            }
            globalID = requestAnimationFrame(draw);
            source.start(0);
        }

        function readme(message) {
            var request = new XMLHttpRequest();
            request.open('POST', url, true);
            request.responseType = 'arraybuffer';
            request.onload = function(){
                context.decodeAudioData(request.response, function(buffer) {
                    playSound(buffer);
                });
            };
            var data = new FormData();
            data.append('message', message);
            data.append('lang', '{{ lang }}');
            request.send(data);
        }

        var globalAnimID;
        function draw() {
            render();
            globalID = requestAnimationFrame(draw);
        }
        var separator=2;
        var height=canvas.height=90;
        var width=canvas.width=200;
        var spacer=2;

        function clear() {
            canvasContext.beginPath();
            canvasContext.clearRect(0, 0, width, height);
            canvasContext.fill();
        }

        function render(){
            var freqByteData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(freqByteData);
            canvasContext.beginPath();
            canvasContext.clearRect(0, 0, width, height);
            canvasContext.fillStyle = '#1ab2ff';
            canvasContext.lineCap = 'round';
            canvasContext.fill();
            for(var i=0;i<analyser.frequencyBinCount;i++){
                canvasContext.fillRect(i*2,height,1,-freqByteData[i]/2);
            }
        }

    var sock = null;
    var wsuri = "{{ websocket }}://"+$(location).attr('host')+"/websocket";

    window.onload = function() {
        connect_to_server()
    };

    function connect_to_server() {
        sock = new WebSocket(wsuri);

        sock.onopen = function() {
            console.log("Web : connected to " + wsuri);
        }

        sock.onclose = function(e) {
            console.log("Web : connection closed (" + e.code + ")");
            setTimeout(function(){connect_to_server()}, 2000);
        }

        sock.onmessage = function(e) {
            console.log("Web : message received: " + e.data);
            var JsonData = jQuery.parseJSON(e.data);
            if(JsonData.hasOwnProperty("message"))
            {
                $('#chat').append('<li class="lisa"><strong>Lisa</strong> > '+JsonData.message+'</li>');
                readme(JsonData.message);
            }
        }
    };

    function send() {
        event.preventDefault(); // Prevent page reload

        var msg = document.getElementById('message').value;
        $('#chat').append('<li class="me"><strong>Me</strong> > '+msg+'</li>');
        sock.send(msg);

        $('#message').onwebkitspeechchange = function(e) {
            console.log("Web : " + e); // SpeechInputEvent
            document.getElementById('sendit').send();

        }

        $('#message').val(''); // Clear input field
    };

</script>

{% endblock %}

{% block content %}
<div class=span12>
    <form id="actionForm" onsubmit="send()">
        <p>
            Message:
            <input id="message" type="text" value="" lang="fr-FR"  x-webkit-speech  speech  onwebkitspeechchange="send();">
        </p>
        <Input type="submit" id="sendit" value="Send Message">
    </form>
</div>
<div class=span10>
    <canvas id='canvas1'>
    </canvas>
</div>
<div style="height: 400px; width: 600px;overflow:auto;">
    <ul id="chat">
    </ul>
</div>
{% endblock %}
